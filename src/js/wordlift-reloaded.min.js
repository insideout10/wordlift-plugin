(function(){var t,e,n,i=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};e=function(){function t(t){this._html=t}var e;return t.prototype._htmlPositions=[],t.prototype._textPositions=[],t.prototype._html="",t.prototype._text="",e=function(t){var e;return e=document.createElement("textarea"),e.innerHTML=t,e.value},t.create=function(e){var n;return(n=new t(e)).parse(),n},t.version="1.0.0",t.prototype.parse=function(){var t,n,i,r,o,s,a,l,d,c,u;for(this._htmlPositions=[],this._textPositions=[],this._text="",a=/([^&<>]*)(&[^&;]*;|<[!\/]?(?:[\w-]+|\[cdata\[.*?]])(?: [\w_-]+(?:="[^"]*")?)*>)([^&<>]*)/gim,d=0,n=0;null!=(s=a.exec(this._html));)r=s[1],t=s[2],c=i=s[3],d+=(u=r+("</p>"===(l=t.toLowerCase())||"</li>"===l?"\n\n":"")).length,/^&[^&;]*;$/gim.test(t)&&(d+=1),n+=r.length+t.length,this._htmlPositions.push(n),this._textPositions.push(d),d+=c.length,n+=i.length,o="",/^&[^&;]*;$/gim.test(t)&&(o=e(t)),this._text+=u+o+c;if(""!==this._text||a.match(this._html)||(this._text=new String(this._html)),0===this._textPositions.length||0!==this._textPositions[0])return this._htmlPositions.unshift(0),this._textPositions.unshift(0)},t.prototype.text2html=function(t){var e,n,i,r,o;for(e=0,o=0,n=i=0,r=this._textPositions.length;(0<=r?i<r:i>r)&&!(t<this._textPositions[n]);n=0<=r?++i:--i)e=this._htmlPositions[n],o=this._textPositions[n];return e+t-o},t.prototype.html2text=function(t){var e,n,i,r,o;if(t<this._htmlPositions[0])return 0;for(e=0,o=0,n=i=0,r=this._htmlPositions.length;(0<=r?i<r:i>r)&&!(t<this._htmlPositions[n]);n=0<=r?++i:--i)e=this._htmlPositions[n],o=this._textPositions[n];return o+t-e},t.prototype.insertHtml=function(t,e){var n;return n=this.text2html(e.text),this._html=this._html.substring(0,n)+t+this._html.substring(n),this.parse()},t.prototype.getHtml=function(){return this._html},t.prototype.getText=function(){return this._text},t}(),window.Traslator=e,angular.module("wordlift.utils.directives",[]).directive("wlOnError",["$parse","$window","$log",function(t,e,n){return{restrict:"A",compile:function(e,n){return function(e,i){var r;return r=t(n.wlOnError),i.on("error",function(t){var n;return n=function(){return r(e,{$event:t})},e.$apply(n)})}}}}]).directive("wlFallback",["$window","$log",function(t,e){return{restrict:"A",priority:99,link:function(t,n,i,r){return n.bind("error",function(){if(i.src!==i.wlFallback)return e.warn("Error on "+i.src+"! Going to fallback on "+i.wlFallback),i.$set("src",i.wlFallback)})}}}]).directive("wlHideAfter",["$timeout","$log",function(t,e){return{restrict:"A",link:function(n,i,r,o){var s;return s=+r.wlHideAfter,t(function(){return e.debug("Remove msg after "+s+" ms"),i.hide()},s)}}}]).directive("wlClipboard",["$timeout","$document","$log",function(t,e,n){return{restrict:"E",scope:{text:"=",onCopied:"&"},transclude:!0,template:'<span \n  class="wl-widget-post-link" \n  ng-class="{\'wl-widget-post-link-copied\' : $copied}"\n  ng-click="copyToClipboard()">\n  <ng-transclude></ng-transclude>\n  <input type="text" ng-value="text" />\n</span>',link:function(i,r,o,s){return i.$copied=!1,i.node=r.find("input"),i.node.css("position","absolute"),i.node.css("left","-10000px"),i.copyToClipboard=function(){var r;try{if(e[0].body.style.webkitUserSelect="initial",(r=e[0].getSelection()).removeAllRanges(),i.node.select(),e[0].execCommand("copy")||n.warn("Error on clipboard copy for "+text),r.removeAllRanges(),i.$copied=!0,t(function(){return n.debug("Going to reset $copied status"),i.$copied=!1},3e3),angular.isFunction(i.onCopied))return i.$evalAsync(i.onCopied())}finally{e[0].body.style.webkitUserSelect=""}}}}}]),angular.module("wordlift.ui.carousel",["ngTouch"]).directive("wlCarousel",["$window","$log",function(t,e){return{restrict:"A",scope:!0,transclude:!0,template:'<div class="wl-carousel" ng-class="{ \'active\' : areControlsVisible }" ng-show="panes.length > 0" ng-mouseover="showControls()" ng-mouseleave="hideControls()">\n  <div class="wl-panes" ng-style="{ width: panesWidth, left: position }" ng-transclude ng-swipe-left="next()" ng-swipe-right="prev()" ></div>\n  <div class="wl-carousel-arrows" ng-show="areControlsVisible" ng-class="{ \'active\' : isActive() }">\n    <i class="wl-angle left" ng-click="prev()" ng-show="isPrevArrowVisible()" />\n    <i class="wl-angle right" ng-click="next()" ng-show="isNextArrowVisible()" />\n  </div>\n</div>',controller:["$scope","$element","$attrs","$log",function(e,n,i,r){var o,s;return s=angular.element(t),e.setItemWidth=function(){return n.width()/e.visibleElements()},e.showControls=function(){return e.areControlsVisible=!0},e.hideControls=function(){return e.areControlsVisible=!1},e.visibleElements=function(){return n.width()>460?4:1},e.isActive=function(){return e.isPrevArrowVisible()||e.isNextArrowVisible()},e.isPrevArrowVisible=function(){return e.currentPaneIndex>0},e.isNextArrowVisible=function(){return e.panes.length-e.currentPaneIndex>e.visibleElements()},e.next=function(){if(!(e.currentPaneIndex+e.visibleElements()+1>e.panes.length))return e.position=e.position-e.itemWidth,e.currentPaneIndex=e.currentPaneIndex+1},e.prev=function(){if(0!==e.currentPaneIndex)return e.position=e.position+e.itemWidth,e.currentPaneIndex=e.currentPaneIndex-1},e.setPanesWrapperWidth=function(){return e.panesWidth=e.panes.length*e.itemWidth,e.position=0,e.currentPaneIndex=0},e.itemWidth=e.setItemWidth(),e.panesWidth=void 0,e.panes=[],e.position=0,e.currentPaneIndex=0,e.areControlsVisible=!1,s.bind("resize",function(){var t,n,i;for(e.itemWidth=e.setItemWidth(),e.setPanesWrapperWidth(),t=0,n=(i=e.panes).length;t<n;t++)i[t].scope.setWidth(e.itemWidth);return e.$apply()}),o=this,o.registerPane=function(t,n,i){var r;return t.setWidth(e.itemWidth),r={scope:t,element:n},e.panes.push(r),e.setPanesWrapperWidth()},o.unregisterPane=function(t){var n,i,r,o,s;for(s=void 0,n=i=0,r=(o=e.panes).length;i<r;n=++i)o[n].scope.$id===t.$id&&(s=n);return e.panes.splice(s,1),e.setPanesWrapperWidth()}}]}}]).directive("wlCarouselPane",["$log",function(t){return{require:"^wlCarousel",restrict:"EA",scope:{wlFirstPane:"="},transclude:!0,template:"<div ng-transclude></div>",link:function(e,n,i,r){return n.addClass("wl-carousel-item"),e.isFirst=e.wlFirstPane||!1,e.setWidth=function(t){return n.css("width",t+"px")},e.$on("$destroy",function(){return t.debug("Destroy "+e.$id),r.unregisterPane(e)}),r.registerPane(e,n,e.isFirst)}}}]),angular.module("wordlift.editpost.widget.controllers.EditPostWidgetController",["wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.GeoLocationService","wordlift.editpost.widget.providers.ConfigurationProvider"]).filter("filterEntitiesByTypesAndRelevance",["configuration","$log",function(t,e){return function(t,e){var n,r,o,s;if(r=[],null==t)return r;Math.floor(1/120*Object.keys(t).length+.75);for(o in t)s=(n=t[o]).mainType,i.call(e,s)>=0&&r.push(n);return r}}]).filter("filterTruncate",["$log",function(t){return function(t,e){var n;return isNaN(e)?t:e<=0?"":(t&&(n=t.split(/\s+/)).length>e&&(t=n.slice(0,e).join(" ")+"…"),t)}}]).filter("filterSplitInRows",["$log",function(t){return function(t){var e;if(t)return t=Math.ceil(t),function(){e=[];for(var n=0,i=t-1;0<=i?n<=i:n>=i;0<=i?n++:n--)e.push(n);return e}.apply(this)}}]).filter("filterEntitiesByTypes",["$log",function(t){return function(t,e){var n,r,o,s;r=[];for(o in t)s=(n=t[o]).mainType,i.call(e,s)>=0&&r.push(n);return r}}]).filter("isEntitySelected",["$log",function(t){return function(t){var e,n,i;n=[];for(i in t)(e=t[i]).occurrences.length>0&&n.push(e);return n}}]).controller("EditPostWidgetController",["GeoLocationService","RelatedPostDataRetrieverService","EditorService","AnalysisService","configuration","$log","$scope","$rootScope",function(t,e,n,r,o,s,a,l){var d,c,u,f;for(a.isRunning=!1,a.isGeolocationRunning=!1,a.analysis=void 0,a.relatedPosts=void 0,a.currentEntity=void 0,a.currentEntityType=void 0,a.setCurrentEntity=function(t,e){var i;switch(a.currentEntity=t,a.currentEntityType=e,e){case"entity":return s.debug("An existing entity. Nothing to do");default:return s.debug("A new entity"),a.currentEntity=r.createEntity(),a.isThereASelection||null!=a.annotation?null!=a.annotation?(i=a.analysis.annotations[a.annotation],void(a.currentEntity.label=i.text)):n.createTextAnnotationFromCurrentSelection():(a.addMsg("Select a text or an existing annotation in order to create a new entity. Text selections are valid only if they do not overlap other existing annotation","error"),void a.unsetCurrentEntity())}},a.unsetCurrentEntity=function(){return a.currentEntity=void 0,a.currentEntityType=void 0},a.storeCurrentEntity=function(){if(a.currentEntity.mainType){switch(a.currentEntityType){case"entity":a.analysis.entities[a.currentEntity.id]=a.currentEntity,a.addMsg("The entity was updated!","positive");break;default:s.debug("Unset a new entity"),a.addNewEntityToAnalysis(),a.addMsg("The entity was created!","positive")}return a.unsetCurrentEntity(),wp.wordlift.trigger("analysis.result",a.analysis)}a.addMsg("Please do not forgive to specify a type for this entity!","error")},a.selectedEntities={},a.currentSection=void 0,a.toggleCurrentSection=function(t){return a.currentSection===t?a.currentSection=void 0:a.currentSection=t},a.isCurrentSection=function(t){return a.currentSection===t},a.suggestedPlaces=void 0,a.publishedPlace=o.publishedPlace,a.topic=void 0,null!=o.publishedPlace&&(a.suggestedPlaces={},a.suggestedPlaces[o.publishedPlace.id]=o.publishedPlace),a.annotation=void 0,a.boxes=[],a.images=[],a.isThereASelection=!1,a.configuration=o,a.messages=[],e.load(Object.keys(a.configuration.entities)),l.$on("analysisFailed",function(t,e){return a.analysisFailed=!0,a.addMsg(e,"error")}),l.$on("analysisServiceStatusUpdated",function(t,e){return a.isRunning=e,n.updateContentEditableStatus(!e)}),l.$watch("selectionStatus",function(){return a.isThereASelection=l.selectionStatus}),c=0,u=(f=a.configuration.classificationBoxes).length;c<u;c++)d=f[c],a.selectedEntities[d.id]={};return a.removeMsg=function(t){return a.messages.splice(t,1)},a.addMsg=function(t,e){return a.messages.unshift({level:e,text:t})},a.selectAnnotation=function(t){return n.selectAnnotation(t)},a.hasAnalysis=function(){return null!=a.analysis},a.isEntitySelected=function(t,e){return null!=a.selectedEntities[e.id][t.id]},a.isLinkedToCurrentAnnotation=function(t){var e;return e=a.annotation,i.call(t.occurrences,e)>=0},a.addNewEntityToAnalysis=function(){var t;return delete a.currentEntity.suggestedSameAs,a.analysis.entities[a.currentEntity.id]=a.currentEntity,(t=a.analysis.annotations[a.annotation]).entityMatches.push({entityId:a.currentEntity.id,confidence:1}),a.analysis.entities[a.currentEntity.id].annotations[t.id]=t,a.analysis.annotations[a.annotation].entities[a.currentEntity.id]=a.currentEntity,a.onSelectedEntityTile(a.analysis.entities[a.currentEntity.id])},a.$on("updateOccurencesForEntity",function(t,e,n){var i,r;if(s.debug("Updating "+n.length+" occurrence(s) for "+e+"..."),a.analysis.entities[e].occurrences=n,wp.wordlift.trigger("updateOccurrencesForEntity",{entityId:e,occurrences:n}),0===n.length){i=a.selectedEntities,r=[];for(d in i)i[d],r.push(delete a.selectedEntities[d][e]);return r}}),a.$watch("annotation",function(t){var e;if(s.debug("Current annotation id changed to "+t),wp.wordlift.trigger("annotation",t),!a.isRunning&&null!=t)return null!=a.currentEntity?(e=a.analysis.annotations[t],a.currentEntity.label=e.text,r.getSuggestedSameAs(e.text)):void 0}),a.$on("textAnnotationClicked",function(t,e){return a.annotation=e,a.unsetCurrentEntity()}),a.$on("textAnnotationAdded",function(t,e){return s.debug("added a new annotation with Id "+e.id),a.analysis.annotations[e.id]=e,a.annotation=e.id}),a.$on("sameAsRetrieved",function(t,e){return a.currentEntity.suggestedSameAs=e}),a.$on("relatedPostsLoaded",function(t,e){return a.relatedPosts=e}),a.$on("analysisPerformed",function(t,e){var n,r,o,l,c,u,f,g,p,h,y,v,w,m,b,E,A;if(a.analysis=e,null!=a.configuration.topic)for(l=0,u=(v=e.topics).length;l<u;l++)w=(A=v[l]).id,i.call(a.configuration.topic.sameAs,w)>=0&&(a.topic=A);for(c=0,f=(m=a.configuration.classificationBoxes).length;c<f;c++)for(h=0,g=(b=(d=m[c]).selectedEntities).length;h<g;h++)if(r=b[h],n=e.entities[r]){if(0===n.occurrences.length){s.warn("Entity "+r+" selected as "+d.label+" without valid occurrences!",n);continue}for(a.selectedEntities[d.id][r]=e.entities[r],y=0,p=(E=n.images).length;y<p;y++)o=E[y],i.call(a.images,o)<0&&a.images.push(o)}else s.warn("Entity with id "+r+" should be linked to "+d.id+" but is missing");return a.currentSection="content-classification"}),a.updateRelatedPosts=function(){var t,n,i,r;s.debug("Going to update related posts box ..."),n=[],r=a.selectedEntities;for(d in r){t=r[d];for(i in t)t[i],n.push(i)}return e.load(n)},a.onSelectedEntityTile=function(t){var e,n,r,l,d,c,u;if(e="entitySelected",null!=a.annotation?(d=a.annotation,i.call(t.occurrences,d)>=0&&(e="entityDeselected")):t.occurrences.length>0&&(e="entityDeselected"),u=o.getCategoryForType(t.mainType),s.debug("Action '"+e+"' on entity "+t.id+" within "+u+" scope"),"entitySelected"===e)for(a.selectedEntities[u][t.id]=t,r=0,l=(c=t.images).length;r<l;r++)n=c[r],i.call(a.images,n)<0&&a.images.push(n);else a.images=a.images.filter(function(e){return i.call(t.images,e)<0});return a.$emit(e,t,a.annotation),wp.wordlift.trigger(e,{entity:t,annotation:a.annotation}),a.updateRelatedPosts(),a.selectAnnotation(void 0)},a.isGeoLocationAllowed=function(){return t.isAllowed()},a.getLocation=function(){return a.isGeolocationRunning=!0,l.$broadcast("geoLocationStatusUpdated",a.isGeolocationRunning),t.getLocation()},a.isPublishedPlace=function(t){var e;return t.id===(null!=(e=a.publishedPlace)?e.id:void 0)},a.hasPublishedPlace=function(){return null!=a.publishedPlace||null!=a.suggestedPlaces},a.onPublishedPlaceSelected=function(t){var e;return(null!=(e=a.publishedPlace)?e.id:void 0)===t.id?(a.publishedPlace=void 0,void(a.suggestedPlaces=void 0)):a.publishedPlace=t},a.$on("currentUserLocalityDetected",function(t,e,n){return s.debug("Looking for entities matching "+e+" for locality "+n),r._innerPerform(e).then(function(t){var e,i,r;a.suggestedPlaces={},r=t.data.entities;for(i in r)"place"===(e=r[i]).mainType&&n===e.label&&(e.id=i,a.onPublishedPlaceSelected(e));return a.isGeolocationRunning=!1,l.$broadcast("geoLocationStatusUpdated",a.isGeolocationRunning)})}),a.$on("geoLocationError",function(t,e){return a.addMsg("Sorry. Looks like something went wrong and WordLift cannot detect your current position. Make sure the ​location services​ of your browser are turned on.","error"),a.isGeolocationRunning=!1,l.$broadcast("geoLocationStatusUpdated",a.isGeolocationRunning)}),a.isTopic=function(t){var e;return t.id===(null!=(e=a.topic)?e.id:void 0)},a.onTopicSelected=function(t){var e;{if((null!=(e=a.topic)?e.id:void 0)!==t.id)return a.topic=t;a.topic=void 0}}}]),angular.module("wordlift.editpost.widget.directives.wlClassificationBox",[]).directive("wlClassificationBox",["configuration","$log",function(t,e){return{restrict:"E",scope:!0,transclude:!0,templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-classification-box.html"},link:function(t,e,n,i){return t.hasSelectedEntities=function(){return Object.keys(t.selectedEntities[t.box.id]).length>0},wp.wordlift.trigger("wlClassificationBox.loaded",t)},controller:function(t,e,n){var i;return t.tiles=[],t.boxes[t.box.id]=t,i=this,i.addTile=function(e){return t.tiles.push(e)},i.closeTiles=function(){var e,n,i,r,o;for(r=[],e=0,n=(i=t.tiles).length;e<n;e++)o=i[e],r.push(o.isOpened=!1);return r}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityList",[]).directive("wlEntityList",["$log",function(t){return{restrict:"A",link:function(){return wp.wordlift.trigger("wlEntityList.loaded")}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityForm",[]).directive("wlEntityForm",["configuration","$window","$log",function(t,e,n){return{restrict:"E",scope:{entity:"=",onSubmit:"&",onReset:"&",box:"="},templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-form.html?ver=3.12.1"},link:function(r,o,s,a){return r.configuration=t,r.currentCategory=void 0,r.$watch("entity.id",function(e){var i,o;if(null!=e)return n.debug("Entity updated to "+e),i=t.getCategoryForType(null!=(o=r.entity)?o.mainType:void 0),n.debug("Going to update current category to "+i),r.currentCategory=i}),r.onSubmitWrapper=function(t){return t.preventDefault(),r.onSubmit()},r.onResetWrapper=function(t){return t.preventDefault(),r.onReset()},r.setCurrentCategory=function(e){var i;if(r.currentCategory=e,i=t.getTypesForCategoryId(e),n.debug("Going to check types"),n.debug(i),1===i.length)return r.setType(i[0])},r.unsetCurrentCategory=function(){var t;return r.currentCategory=void 0,null!=(t=r.entity)?t.mainType=void 0:void 0},r.isSameAsOf=function(t){var e;return e=t.id,i.call(r.entity.sameAs,e)>=0},r.addSameAs=function(t){var e,n,o,s,a;return(null!=(n=r.entity)?n.sameAs:void 0)||null!=(o=r.entity)&&(o.sameAs=[]),s=t.id,i.call(r.entity.sameAs,s)>=0?(e=r.entity.sameAs.indexOf(t.id),r.entity.sameAs.splice(e,1)):null!=(a=r.entity)?a.sameAs.push(t.id):void 0},r.setType=function(t){var e,n;if(t!==(null!=(e=r.entity)?e.mainType:void 0))return null!=(n=r.entity)?n.mainType=t:void 0},r.isCurrentType=function(t){var e;return(null!=(e=r.entity)?e.mainType:void 0)===t},r.getAvailableTypes=function(){return t.getTypesForCategoryId(r.currentCategory)},r.removeCurrentImage=function(t){var e;return e=r.entity.images.splice(t,1),n.warn("Removed "+e+" from entity "+r.entity.id+" images collection")},r.linkToEdit=function(t){return t.preventDefault(),e.location.href=ajaxurl+"?action=wordlift_redirect&uri="+e.encodeURIComponent(r.entity.id)+"&to=edit"},r.hasOccurences=function(){var t;return(null!=(t=r.entity.occurrences)?t.length:void 0)>0},r.setSameAs=function(t){return r.entity.sameAs=t},r.isInternal=function(){var e;return t.isInternal(null!=(e=r.entity)?e.id:void 0)},r.isNew=function(t){var e;return!/^(f|ht)tps?:\/\//i.test(null!=(e=r.entity)?e.id:void 0)}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityTile",[]).directive("wlEntityTile",["configuration","$log",function(t,e){return{require:"?^wlClassificationBox",restrict:"E",scope:{entity:"=",isSelected:"=",showConfidence:"=",onSelect:"&",onMore:"&"},templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-tile.html"},link:function(e,n,i,r){return e.configuration=t,null!=r&&r.addTile(e),e.isOpened=!1,e.isInternal=function(){return!!e.entity.id.startsWith(t.datasetUri)},e.toggle=function(){return e.isOpened||null!=r&&r.closeTiles(),e.isOpened=!e.isOpened}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityInputBox",[]).directive("wlEntityInputBox",["configuration","$log",function(t,e){return{restrict:"E",scope:{entity:"="},templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-input-box.html?ver=3.12.1"}}}]),angular.module("wordlift.editpost.widget.services.EditorAdapter",["wordlift.editpost.widget.services.EditorAdapter"]).service("EditorAdapter",["$log",function(t){var e;return e={getEditor:function(t){return null==t&&(t="content"),tinyMCE.get(t)},getHTML:function(t){return e.getEditor(t).getContent({format:"raw"})}}}]),angular.module("wordlift.editpost.widget.services.AnnotationParser",[]).service("AnnotationParser",["$log",function(t){return{parse:function(t){var n,i,r,o,s;for(s=e.create(t),r=/<(\w+)[^>]*\sitemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,o=[];i=r.exec(t);)n={start:s.html2text(i.index),end:s.html2text(i.index+i[0].length),uri:i[2],label:i[3]},o.push(n);return o}}}]),angular.module("wordlift.editpost.widget.services.AnalysisService",["wordlift.editpost.widget.services.AnnotationParser","wordlift.editpost.widget.services.EditorAdapter"]).service("AnalysisService",["AnnotationParser","EditorAdapter","configuration","$log","$http","$rootScope",function(t,n,r,o,s,a){var l,d,c,u,f,g,p,h,y,v,w,m;for(m=function(t){var e;for(null==t&&(t=8),e="";e.length<t;)e+=Math.random().toString(36).substr(2);return e.substr(0,t)},p=function(t,e){return l(l({},t),e)},l=function(t,e){var n,i;for(n in e)i=e[n],t[n]=i;return t},d=function(t,e,n){var i,r;for(r in t)if((i=t[r]).start===e&&i.end===n)return i},(v={_isRunning:!1,_currentAnalysis:void 0,_supportedTypes:[],_defaultType:"thing"}).cleanAnnotations=function(t,e){var n,r,s,a,l,d,c,u,f,g;null==e&&(e=[]),u=t.annotations;for(r in u)if((n=u[r]).start>0&&n.end>n.start){for(a=!1,l=0,d=(s=function(){g=[];for(var t=f=n.start,e=n.end;f<=e?t<=e:t>=e;f<=e?t++:t--)g.push(t);return g}.apply(this)).length;l<d;l++){c=s[l],i.call(e,c)>=0&&(a=!0);break}a?(o.warn("Annotation with id: "+r+" start: "+n.start+" end: "+n.end+" overlaps an existing annotation"),this.deleteAnnotation(t,r)):e=e.concat(s)}return t},c=0,f=(h=r.classificationBoxes).length;c<f;c++)for(u=0,g=(y=h[c].registeredTypes).length;u<g;u++)w=y[u],i.call(v._supportedTypes,w)<0&&v._supportedTypes.push(w);return v.createEntity=function(t){var e;return null==t&&(t={}),e={id:"local-entity-"+m(32),label:"",description:"",mainType:"",types:[],images:[],confidence:1,occurrences:[],annotations:{}},p(e,t)},v.deleteAnnotation=function(t,e){var n,i,r,s,a;if(o.warn("Going to remove overlapping annotation with id "+e),null!=t.annotations[e]){for(i=r=0,s=(a=t.annotations[e].entityMatches).length;r<s;i=++r)n=a[i],delete t.entities[n.entityId].annotations[e];delete t.annotations[e]}return t},v.createAnnotation=function(t){var e;return null==t&&(t={}),e={id:"urn:local-text-annotation-"+m(32),text:"",start:0,end:0,entities:[],entityMatches:[]},p(e,t)},v.parse=function(t){var e,n,s,a,l,d,c,u,f,g,p,h,y,v,w,m,b,E,A,x,$,S,P,C;s=this._defaultType,t.topics=t.topics.map(function(t){return t.id=t.uri,t.occurrences=[],t.mainType=s,t}),o.debug("Found "+Object.keys(r.entities).length+" entities in configuration...",r),b=r.entities;for(c in b)h=b[c],t.entities[c]=h;E=t.entities;for(c in E)d=E[c],r.currentPostUri!==c?(d.label||o.warn("Label missing for entity "+c),d.description||o.warn("Description missing for entity "+c),d.sameAs||(o.warn("sameAs missing for entity "+c),d.sameAs=[],null!=(A=r.entities[c])&&(A.sameAs=[]),o.debug("Schema.org sameAs overridden for entity "+c)),x=d.mainType,i.call(this._supportedTypes,x)<0&&(o.warn("Schema.org type "+d.mainType+" for entity "+c+" is not supported from current classification boxes configuration"),d.mainType=this._defaultType,null!=($=r.entities[c])&&($.mainType=this._defaultType),o.debug("Schema.org type overridden for entity "+c)),d.id=c,d.occurrences=[],d.annotations={}):delete t.entities[c];S=t.annotations;for(c in S)if(e=S[c],e.id=c,e.entities={},t.annotations[c].entityMatches=function(){var n,i,r,o;for(o=[],n=0,i=(r=e.entityMatches).length;n<i;n++)(a=r[n]).entityId in t.entities&&o.push(a);return o}(),0!==t.annotations[c].entityMatches.length)for(u=f=0,g=(P=t.annotations[c].entityMatches).length;f<g;u=++f)a=P[u],t.entities[a.entityId].label||(t.entities[a.entityId].label=e.text,o.debug("Missing label retrieved from related annotation for entity "+a.entityId)),t.entities[a.entityId].annotations[c]=e,t.annotations[c].entities[a.entityId]=t.entities[a.entityId];else delete t.annotations[c];C=t.entities;for(c in C){d=C[c],w=t.annotations;for(n in w){for(y=1,v=0,p=(m=(e=w[n]).entityMatches).length;v<p;v++)null!=(l=m[v]).entityId&&l.entityId===c&&(y=l.confidence);d.confidence=d.confidence*y}}return t},v.getSuggestedSameAs=function(t){var e,n,i,r,s;this._innerPerform(t).then(function(t){}),s=[],r=response.data.entities;for(n in r)e=r[n],(i=n.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i))&&s.push({id:n,label:e.label,mainType:e.mainType,source:i[1]});return o.debug(s),a.$broadcast("sameAsRetrieved",s)},v._innerPerform=function(t,n){var i;return null==n&&(n=[]),i={method:"post",url:ajaxurl+"?action=wordlift_analyze"},i.headers={"Content-Type":"application/json"},i.data={content:t,annotations:n,contentType:"text/html",version:e.version},"undefined"!=typeof wlSettings&&null!==wlSettings&&(null!=wlSettings.language&&(i.data.contentLanguage=wlSettings.language),null!=wlSettings.itemId&&(i.data.exclude=[wlSettings.itemId])),s(i)},v._updateStatus=function(t){return v._isRunning=t,a.$broadcast("analysisServiceStatusUpdated",t)},v.perform=function(e){var i,r;return v._currentAnalysis?(o.warn("Analysis already run! Nothing to do ..."),void v._updateStatus(!1)):(v._updateStatus(!0),i=t.parse(n.getHTML()),o.debug("Requesting analysis..."),(r=this._innerPerform(e,i)).then(function(t){var e;{if(null==t.data.success||t.data.success)return v._currentAnalysis=t.data,e=v.parse(t.data),a.$broadcast("analysisPerformed",e),wp.wordlift.trigger("analysis.result",e);a.$broadcast("analysisFailed",t.data.data.message)}}),r.catch(function(t){return o.error(t.data),a.$broadcast("analysisFailed",t.data)}),r.finally(function(t){return v._updateStatus(!1)}))},v.preselect=function(t,e){var n,s,a,l,c,u,f,g,p,h;for(o.debug("Selecting "+e.length+" entity annotation(s)..."),p=[],c=0,u=e.length;c<u;c++)if((n=e[c]).start!==n.end){null==(h=d(t.annotations,n.start,n.end))&&(o.warn("Text annotation "+n.start+":"+n.end+" for entityId "+n.uri+" misses in the analysis"),h=this.createAnnotation({start:n.start,end:n.end,text:n.label,cssClass:null!=n.cssClass?n.cssClass:void 0}),t.annotations[h.id]=h),a=t.entities[n.uri],f=r.entities;for(l in f)s=f[l],g=n.uri,i.call(s.sameAs,g)>=0&&(a=t.entities[s.id]);null!=a?(t.entities[a.id].occurrences.push(h.id),null==t.entities[a.id].annotations[h.id]?(t.entities[a.id].annotations[h.id]=h,t.annotations[h.id].entityMatches.push({entityId:a.id,confidence:1}),p.push(t.annotations[h.id].entities[a.id]=t.entities[a.id])):p.push(void 0)):o.warn("Entity with uri "+n.uri+" is missing both in analysis results and in local storage")}else o.warn("There is a broken empty annotation for entityId "+n.uri);return p},v}]),angular.module("wordlift.editpost.widget.services.EditorService",["wordlift.editpost.widget.services.EditorAdapter","wordlift.editpost.widget.services.AnalysisService"]).service("EditorService",["configuration","AnalysisService","EditorAdapter","$log","$http","$rootScope",function(t,n,r,o,s,a){var l,d,c,u,f,g;return"\ufeff",u=function(t){var n,i,r,o,s;for(s=e.create(t),r=/<(\w+)[^>]*\sclass="([^"]+)"\s+(?:id="[^"]+"\s+)?itemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,o=[];i=r.exec(t);)n={start:s.html2text(i.index),end:s.html2text(i.index+i[0].length),uri:i[3],label:i[4],cssClass:i[2]},o.push(n);return o},f=function(t){var e,n,i,r,o,s;for(r=[],n=0,i=t.length;n<i;n++)e=t[n],r=r.concat(function(){s=[];for(var t=o=e.start,n=e.end;o<=n?t<=n:t>=n;o<=n?t++:t--)s.push(t);return s}.apply(this));return r},function(){return tinyMCE.get("content")},c=function(e,n){var i,o,s,a,l,d;for((o=r.getEditor()).dom.addClass(e,"disambiguated"),s=0,a=(l=t.types).length;s<a;s++)d=l[s],o.dom.removeClass(e,d.css);return o.dom.removeClass(e,"unlinked"),o.dom.addClass(e,"wl-"+n.mainType),i=o.dom.getAttrib(e,"itemid"),o.dom.setAttrib(e,"itemid",n.id),i},d=function(t,e){var n,i;return(i=r.getEditor()).dom.removeClass(t,"disambiguated"),i.dom.removeClass(t,"wl-"+e.mainType),n=i.dom.getAttrib(t,"itemid"),i.dom.setAttrib(t,"itemid",""),n},l=function(t){var e,n,i,s,a,l;if(o.info("Calculating occurrences for entity "+t+"..."),i=r.getEditor(),l=[],""===t)return l;for(n=i.dom.select("span.textannotation"),o.info("Found "+n.length+" annotation(s) for entity "+t+"."),s=0,a=n.length;s<a;s++)e=n[s],i.dom.getAttrib(e.id,"itemid")===t&&l.push(e.id);return l},a.$on("analysisPerformed",function(t,e){if(null!=e&&null!=e.annotations)return g.embedAnalysis(e)}),a.$on("entitySelected",function(t,e,n){var i,r,o,s,d,u,f,g;if(r=[],null!=n)r.push(c(n,e));else{g=e.annotations;for(s in g)i=g[s],r.push(c(i.id,e))}for(d=0,u=r.length;d<u;d++)(o=r[d])&&(f=l(o),a.$broadcast("updateOccurencesForEntity",o,f));return f=l(e.id),a.$broadcast("updateOccurencesForEntity",e.id,f)}),a.$on("entityDeselected",function(t,e,n){var i,r,o,s;if(null!=n)d(n,e);else{s=e.annotations;for(r in s)i=s[r],d(i.id,e)}return o=l(e.id),a.$broadcast("updateOccurencesForEntity",e.id,o)}),g={hasSelection:function(){var t;return null!=(t=r.getEditor())&&(!t.selection.isCollapsed()&&(!/<([\/]*[a-z]+)[^<]*>/.test(t.selection.getContent())||(o.warn("The selection overlaps html code"),!1)))},isEditor:function(t){return r.getEditor().id===t.id},updateContentEditableStatus:function(t){return r.getEditor().getBody().setAttribute("contenteditable",t)},createTextAnnotationFromCurrentSelection:function(){var t,i,s,l,d,c,u,f;if(!(i=r.getEditor()).selection.isCollapsed())return l=""+i.selection.getSel(),d=n.createAnnotation({text:l}),c='<span id="'+d.id+'" class="textannotation unlinked selected">'+i.selection.getContent()+"</span>\ufeff",i.selection.setContent(c),t=r.getHTML(),f=e.create(t),s=t.indexOf(c),u=f.html2text(s),d.start=u,d.end=d.start+l.length,a.$broadcast("textAnnotationAdded",d);o.warn("Invalid selection! The text annotation cannot be created")},selectAnnotation:function(t){var e,n,i,o,s;for(i=0,o=(s=(n=r.getEditor()).dom.select("span.textannotation")).length;i<o;i++)e=s[i],n.dom.removeClass(e.id,"selected");if(a.$broadcast("textAnnotationClicked",void 0),n.dom.hasClass(t,"textannotation"))return n.dom.addClass(t,"selected"),a.$broadcast("textAnnotationClicked",t)},embedAnalysis:function(t){return function(t){var s,l,d,c,g,p,h,y,v,w,m,b,E,A,x,$;for(d=r.getEditor(),y=r.getHTML(),p=u(y),n.cleanAnnotations(t,f(p)),n.preselect(t,p);y.match(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]+)<\/\1>/gim,"$2");)y=y.replace(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]*)<\/\1>/gim,"$2");$=e.create(y),b=t.annotations;for(l in b)if(0!==(s=b[l]).entityMatches.length){for(c='<span id="'+l+'" class="textannotation',-1<(null!=(E=s.cssClass)?E.indexOf("wl-no-link"):void 0)&&(c+=" wl-no-link"),-1<(null!=(A=s.cssClass)?A.indexOf("wl-link"):void 0)&&(c+=" wl-link"),w=0,m=(x=s.entityMatches).length;w<m;w++)g=x[w],h=t.entities[g.entityId],i.call(h.occurrences,l)>=0&&(c+=" disambiguated wl-"+h.mainType+'" itemid="'+h.id);c+='">',$.insertHtml(c,{text:s.start}),$.insertHtml("</span>",{text:s.end})}else o.warn("Annotation "+s.text+" ["+s.start+":"+s.end+"] with id "+s.id+" has no entity matches!");return y=$.getHtml(),y=y.replace(/<\/span>/gim,"</span>\ufeff"),a.$broadcast("analysisEmbedded"),v=d.isDirty(),d.setContent(y,{format:"raw"}),d.isNotDirty=!v}}()}}]),angular.module("wordlift.editpost.widget.services.RelatedPostDataRetrieverService",[]).service("RelatedPostDataRetrieverService",["configuration","$log","$http","$rootScope",function(t,e,n,i){var r;return r={},r.load=function(r){var o;return null==r&&(r=[]),o="admin-ajax.php?action=wordlift_related_posts&post_id="+t.currentPostId,n({method:"post",url:o,data:r}).success(function(t){return i.$broadcast("relatedPostsLoaded",t)}).error(function(t,n){return e.warn("Error loading related posts")})},r}]),angular.module("wordlift.editpost.widget.services.GeoLocationService",["geolocation"]).service("GeoLocationService",["configuration","geolocation","$log","$rootScope","$document","$q","$timeout","$window",function(t,e,n,r,o,s,a,l){var d,c,u,f;return"locality","AIzaSyAhsajbqNVd7ABlkZvskWIPdiX6M3OaaNM",d="https://maps.googleapis.com/maps/api/js?language="+t.currentLanguage+"&key=AIzaSyAhsajbqNVd7ABlkZvskWIPdiX6M3OaaNM",r.$on("error",function(t,e){return n.warn("Geolocation error: "+e),r.$broadcast("geoLocationError",e)}),this.googleApiLoaded=!1,this.googleApiPromise=void 0,u=function(){var t,e,n;return null!=this.googleApiPromise?this.googleApiPromise:(e=s.defer(),n=o[0].createElement("script"),n.src=d,o[0].body.appendChild(n),t=function(t){var i;if(!n.readyState||"complete"===(i=n.readyState)||"loaded"===i)return a(function(){return e.resolve(t)})},n.onload=t,n.onreadystatechange=t,n.onerror=function(t){return a(function(){return e.reject(t)})},this.googleApiPromise=e.promise,this.googleApiPromise)},c=function(){var t,e,n;n=l.navigator.userAgent,t={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer/i};for(e in t)if(t[e].test(n))return e;return"unknown"},f={},f.isAllowed=function(){return"chrome"!==c()||"https:"===l.location.protocol},f.getLocation=function(){return e.getLocation().then(function(t){return n.debug("Detected position: latitude "+t.coords.latitude+", longitude "+t.coords.longitude),u().then(function(){return(new google.maps.Geocoder).geocode({location:{lat:t.coords.latitude,lng:t.coords.longitude}},function(t,e){var n,o,s,a,l,d,c;if(e===google.maps.GeocoderStatus.OK)for(o=0,a=t.length;o<a;o++)if(c=t[o],i.call(c.types,"locality")>=0)for(s=0,l=(d=c.address_components).length;s<l;s++)if(n=d[s],i.call(n.types,"locality")>=0)return void r.$broadcast("currentUserLocalityDetected",c.formatted_address,n.long_name)})})})},f}]),angular.module("wordlift.editpost.widget.providers.ConfigurationProvider",[]).provider("configuration",function(){var t;return t=void 0,{setConfiguration:function(e){return t=e,t.getCategoryForType=function(t){var e,n,r,o;if(t)for(n=0,r=(o=this.classificationBoxes).length;n<r;n++)if(e=o[n],i.call(e.registeredTypes,t)>=0)return e.id},t.getTypesForCategoryId=function(t){var e,n,i,r;if(!t)return[];for(n=0,i=(r=this.classificationBoxes).length;n<i;n++)if(e=r[n],t===e.id)return e.registeredTypes},t.isInternal=function(t){return null!=t?t.startsWith(this.datasetUri):void 0},t.getUriForType=function(t){var e,n,i,r;for(e=0,n=(i=this.types).length;e<n;e++)if((r=i[e]).css==="wl-"+t)return r.uri}},$get:function(){return t}}}),t=jQuery,angular.module("wordlift.editpost.widget",["ngAnimate","wordlift.ui.carousel","wordlift.utils.directives","wordlift.editpost.widget.providers.ConfigurationProvider","wordlift.editpost.widget.controllers.EditPostWidgetController","wordlift.editpost.widget.directives.wlClassificationBox","wordlift.editpost.widget.directives.wlEntityList","wordlift.editpost.widget.directives.wlEntityForm","wordlift.editpost.widget.directives.wlEntityTile","wordlift.editpost.widget.directives.wlEntityInputBox","wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.RelatedPostDataRetrieverService"]).config(function(t){return t.setConfiguration(window.wordlift)}),t(t('<div\n      id="wordlift-edit-post-wrapper"\n      ng-controller="EditPostWidgetController"\n      ng-include="configuration.defaultWordLiftPath + \'templates/wordlift-widget-be/wordlift-editpost-widget.html?ver=3.12.1\'">\n    </div>').appendTo("#wordlift-edit-post-outer-wrapper"),t('<div class="wl-widget-spinner">\n  <svg transform-origin="10 10" id="wl-widget-spinner-blogger">\n    <circle cx="10" cy="10" r="6" class="wl-blogger-shape"></circle>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-editorial">\n    <rect x="4" y="4" width="12" height="12" class="wl-editorial-shape"></rect>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-enterprise">\n    <polygon points="3,10 6.5,4 13.4,4 16.9,10 13.4,16 6.5,16" class="wl-enterprise-shape"></polygon>\n  </svg>\n</div> ').appendTo("#wordlift_entities_box .ui-sortable-handle"),n=angular.bootstrap(t("#wordlift-edit-post-wrapper"),["wordlift.editpost.widget"]),n.invoke(["$rootScope","$log",function(e,n){return e.$on("analysisServiceStatusUpdated",function(e,n){var i;return i=n?"wl-spinner-running":"",t(".wl-widget-spinner svg").attr("class",i)}),e.$on("geoLocationStatusUpdated",function(e,n){var i;return i=n?"wl-spinner-running":"",t(".wl-widget-spinner svg").attr("class",i)})}]),tinymce.PluginManager.add("wordlift",function(t,e){var i;if("content"===t.id)return i=function(t,e,n){switch(tinymce.majorVersion){case"4":return t.on(e,n);case"3":return t["on"+e].add(n)}},n.invoke(["EditorService","$rootScope","$log",function(t,e,n){var i,r,o,s,a,l;for(null!=wp.autosave&&(wp.autosave.server.postChanged=function(){return!1}),l=[],i=0,r=(a=["setMarkers","toViews"]).length;i<r;i++){if(o=a[i],null!=wp.mce.views[o]){s=wp.mce.views[o],n.warn("Override wp.mce.views method "+o+"() to prevent shortcodes rendering"),wp.mce.views[o]=function(t){return t},e.$on("analysisEmbedded",function(t){return n.info("Going to restore wp.mce.views method "+o+"()"),wp.mce.views[o]=s}),e.$on("analysisFailed",function(t){return n.info("Going to restore wp.mce.views method "+o+"()"),wp.mce.views[o]=s});break}l.push(void 0)}return l}]),i(t,"LoadContent",function(e){return n.invoke(["AnalysisService","EditorService","$rootScope","$log",function(e,n,i,r){return i.$apply(function(){var i;if(""!==(i=t.getContent({format:"raw"})))return n.updateContentEditableStatus(!1),e.perform(i)})}])}),i(t,"NodeChange",function(t){return n.invoke(["AnalysisService","EditorService","$rootScope","$log",function(t,e,n,i){return t._currentAnalysis&&n.$apply(function(){return n.selectionStatus=e.hasSelection()}),!0}])}),i(t,"Click",function(t){return n.invoke(["AnalysisService","EditorService","$rootScope","$log",function(e,n,i,r){return e._currentAnalysis&&i.$apply(function(){return n.selectAnnotation(t.target.id)}),!0}])})}))}).call(this);