(function(){var c,A,f,P=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};A=function(){var c;function n(t){this._html=t}return n.prototype._htmlPositions=[],n.prototype._textPositions=[],n.prototype._htmlFragments=[],n.prototype._html="",n.prototype._text="",c=function(t){var e;return(e=document.createElement("textarea")).innerHTML=t,e.value},n.create=function(t){var e;return(e=new n(t)).parse(),e},n.version="1.0.0",n.prototype.parse=function(){var t,e,n,i,r,o,s,a,l,d,u;for(this._htmlPositions=[],this._textPositions=[],this._htmlFragments=[],this._text="",s=/((?:&(?![#\w]))*[^&<>]*)(&[^&;]*;|<[!\/]?(?:[\w-]+|\[cdata\[.*?]])(?: [\w_-]+(?:="[^"]*")?)*[^>]*>)([^&<>]*)/gim,e=l=0;null!=(o=s.exec(this._html));)i=o[1],t=o[2],d=n=o[3],l+=(u=i+("</p>"===(a=t.toLowerCase())||"</li>"===a?"\n\n":"")).length,/^&[^&;]*;$/gim.test(t)&&(l+=1),e+=i.length,t.startsWith("<br")&&(this._htmlPositions.push(e),this._textPositions.push(l),this._htmlFragments.push(t)),e+=t.length,this._htmlPositions.push(e),this._textPositions.push(l),this._htmlFragments.push(t),l+=d.length,e+=n.length,r="",/^&[^&;]*;$/gim.test(t)&&(r=c(t)),this._text+=u+r+d;if(""!==this._text||s.match(this._html)||(this._text=new String(this._html)),0===this._textPositions.length||0!==this._textPositions[0])return this._htmlPositions.unshift(0),this._textPositions.unshift(0)},n.prototype.text2html=function(t){var e,n,i,r,o;for(n=i=o=e=0,r=this._textPositions.length;(0<=r?i<r:r<i)&&!(t<this._textPositions[n])&&(e=this._htmlPositions[n],o=this._textPositions[n],t!==this._textPositions[n]||!this._htmlFragments[n].startsWith("<br"));n=0<=r?++i:--i);return e+t-o},n.prototype.html2text=function(t){var e,n,i,r,o;if(t<this._htmlPositions[0])return 0;for(n=i=o=e=0,r=this._htmlPositions.length;(0<=r?i<r:r<i)&&!(t<this._htmlPositions[n]);n=0<=r?++i:--i)e=this._htmlPositions[n],o=this._textPositions[n];return o+t-e},n.prototype.insertHtml=function(t,e){var n;return n=this.text2html(e.text),this._html=this._html.substring(0,n)+t+this._html.substring(n),this.parse()},n.prototype.getHtml=function(){return this._html},n.prototype.getText=function(){return this._text},n}(),window.Traslator=A,angular.module("wordlift.utils.directives",[]).directive("wlOnError",["$parse","$window","$log",function(r,t,e){return{restrict:"A",compile:function(t,e){return function(n,t){var i;return i=r(e.wlOnError),t.on("error",function(t){var e;return e=function(){return i(n,{$event:t})},n.$apply(e)})}}}}]).directive("wlFallback",["$window","$log",function(t,r){return{restrict:"A",priority:99,link:function(t,e,n,i){return e.bind("error",function(){if(n.src!==n.wlFallback)return r.warn("Error on "+n.src+"! Going to fallback on "+n.wlFallback),n.$set("src",n.wlFallback)})}}}]).directive("wlHideAfter",["$timeout","$log",function(o,s){return{restrict:"A",link:function(t,e,n,i){var r;return r=+n.wlHideAfter,o(function(){return s.debug("Remove msg after "+r+" ms"),e.hide()},r)}}}]).directive("wlClipboard",["$timeout","$document","$log",function(r,o,s){return{restrict:"E",scope:{text:"=",onCopied:"&"},transclude:!0,template:'<span \n  class="wl-widget-post-link" \n  ng-class="{\'wl-widget-post-link-copied\' : $copied}"\n  ng-click="copyToClipboard()">\n  <ng-transclude></ng-transclude>\n  <input type="text" ng-value="text" />\n</span>',link:function(e,t,n,i){return e.$copied=!1,e.node=t.find("input"),e.node.css("position","absolute"),e.node.css("left","-10000px"),e.copyToClipboard=function(){var t;try{if(o[0].body.style.webkitUserSelect="initial",(t=o[0].getSelection()).removeAllRanges(),e.node.select(),o[0].execCommand("copy")||s.warn("Error on clipboard copy for "+text),t.removeAllRanges(),e.$copied=!0,r(function(){return s.debug("Going to reset $copied status"),e.$copied=!1},3e3),angular.isFunction(e.onCopied))return e.$evalAsync(e.onCopied())}finally{o[0].body.style.webkitUserSelect=""}}}}}]),angular.module("wordlift.ui.carousel",["ngTouch"]).directive("wlCarousel",["$window","$log",function(o,t){return{restrict:"A",scope:!0,transclude:!0,template:'<div class="wl-carousel" ng-class="{ \'active\' : areControlsVisible }" ng-show="panes.length > 0" ng-mouseover="showControls()" ng-mouseleave="hideControls()">\n  <div class="wl-panes" ng-style="{ width: panesWidth, left: position }" ng-transclude ng-swipe-left="next()" ng-swipe-right="prev()" ></div>\n  <div class="wl-carousel-arrows" ng-show="areControlsVisible" ng-class="{ \'active\' : isActive() }">\n    <i class="wl-angle left" ng-click="prev()" ng-show="isPrevArrowVisible()" />\n    <i class="wl-angle right" ng-click="next()" ng-show="isNextArrowVisible()" />\n  </div>\n</div>',controller:["$scope","$element","$attrs","$log",function(s,t,e,n){var i,r;return r=angular.element(o),s.setItemWidth=function(){return t.width()/s.visibleElements()},s.showControls=function(){return s.areControlsVisible=!0},s.hideControls=function(){return s.areControlsVisible=!1},s.visibleElements=function(){return 460<t.width()?4:1},s.isActive=function(){return s.isPrevArrowVisible()||s.isNextArrowVisible()},s.isPrevArrowVisible=function(){return 0<s.currentPaneIndex},s.isNextArrowVisible=function(){return s.panes.length-s.currentPaneIndex>s.visibleElements()},s.next=function(){if(!(s.currentPaneIndex+s.visibleElements()+1>s.panes.length))return s.position=s.position-s.itemWidth,s.currentPaneIndex=s.currentPaneIndex+1},s.prev=function(){if(0!==s.currentPaneIndex)return s.position=s.position+s.itemWidth,s.currentPaneIndex=s.currentPaneIndex-1},s.setPanesWrapperWidth=function(){return s.panesWidth=s.panes.length*s.itemWidth,s.position=0,s.currentPaneIndex=0},s.itemWidth=s.setItemWidth(),s.panesWidth=void 0,s.panes=[],s.position=0,s.currentPaneIndex=0,s.areControlsVisible=!1,i=function(){var t,e,n;for(s.itemWidth=s.setItemWidth(),s.setPanesWrapperWidth(),t=0,e=(n=s.panes).length;t<e;t++)n[t].scope.setWidth(s.itemWidth);return s.$apply()},r.bind("resize",function(){return i}),r.bind("load",function(){return i}),this.registerPane=function(t,e,n){var i;return t.setWidth(s.itemWidth),i={scope:t,element:e},s.panes.push(i),s.setPanesWrapperWidth()},this.unregisterPane=function(t){var e,n,i,r,o;for(o=void 0,e=n=0,i=(r=s.panes).length;n<i;e=++n)r[e].scope.$id===t.$id&&(o=e);return s.panes.splice(o,1),s.setPanesWrapperWidth()}}]}}]).directive("wlCarouselPane",["$log",function(r){return{require:"^wlCarousel",restrict:"EA",scope:{wlFirstPane:"="},transclude:!0,template:"<div ng-transclude></div>",link:function(t,e,n,i){return e.addClass("wl-carousel-item"),t.isFirst=t.wlFirstPane||!1,t.setWidth=function(t){return e.css("width",t+"px")},t.$on("$destroy",function(){return r.debug("Destroy "+t.$id),i.unregisterPane(t)}),i.registerPane(t,e,t.isFirst)}}}]),angular.module("wordlift.editpost.widget.controllers.EditPostWidgetController",["wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.GeoLocationService","wordlift.editpost.widget.providers.ConfigurationProvider"]).filter("filterEntitiesByTypesAndRelevance",["configuration","$log",function(t,e){return function(t,e){var n,i,r,o;if(i=[],null==t)return i;for(r in Math.floor(1/120*Object.keys(t).length+.75),t)o=(n=t[r]).mainType,0<=P.call(e,o)&&i.push(n);return i}}]).filter("filterTruncate",["$log",function(t){return function(t,e){var n;return isNaN(e)?t:e<=0?"":(t&&(n=t.split(/\s+/)).length>e&&(t=n.slice(0,e).join(" ")+"â€¦"),t)}}]).filter("filterSplitInRows",["$log",function(t){return function(n){var i;if(n)return n=Math.ceil(n),function(){i=[];for(var t=0,e=n-1;0<=e?t<=e:e<=t;0<=e?t++:t--)i.push(t);return i}.apply(this)}}]).filter("filterEntitiesByTypes",["$log",function(t){return function(t,e){var n,i,r,o;for(r in i=[],t)o=(n=t[r]).mainType,0<=P.call(e,o)&&i.push(n);return i}}]).filter("isEntitySelected",["$log",function(t){return function(t){var e,n,i;for(i in n=[],t)0<(e=t[i]).occurrences.length&&n.push(e);return n}}]).controller("EditPostWidgetController",["GeoLocationService","RelatedPostDataRetrieverService","EditorService","AnalysisService","configuration","$log","$scope","$rootScope",function(t,r,i,o,l,m,b,s){var x,e,n,a;for(b.isRunning=!1,b.isGeolocationRunning=!1,b.analysis=void 0,b.relatedPosts=void 0,b.currentEntity=void 0,b.currentEntityType=void 0,b.canCreateEntities=o.canCreateEntities,b.setCurrentEntity=function(t,e){var n;switch(b.currentEntity=t,b.currentEntityType=e){case"entity":return m.debug("An existing entity. Nothing to do");default:return m.debug("A new entity"),b.currentEntity=o.createEntity(),b.isThereASelection||null!=b.annotation?null!=b.annotation?(n=b.analysis.annotations[b.annotation],void(b.currentEntity.label=n.text)):i.createTextAnnotationFromCurrentSelection():(b.addMsg("Select a text or an existing annotation in order to create a new entity. Text selections are valid only if they do not overlap other existing annotation","error"),void b.unsetCurrentEntity())}},b.unsetCurrentEntity=function(){return b.currentEntity=void 0,b.currentEntityType=void 0},b.storeCurrentEntity=function(){if(b.currentEntity.mainType){switch(b.currentEntityType){case"entity":b.analysis.entities[b.currentEntity.id]=b.currentEntity,b.addMsg("The entity was updated!","positive");break;default:m.debug("Unset a new entity"),b.addNewEntityToAnalysis(),b.addMsg("The entity was created!","positive")}return b.unsetCurrentEntity(),wp.wordlift.trigger("analysis.result",b.analysis)}b.addMsg("Select an entity type.","error")},b.selectedEntities={},b.currentSection=void 0,b.toggleCurrentSection=function(t){return b.currentSection===t?b.currentSection=void 0:b.currentSection=t},b.isCurrentSection=function(t){return b.currentSection===t},b.suggestedPlaces=void 0,b.publishedPlace=l.publishedPlace,b.topic=void 0,null!=l.publishedPlace&&(b.suggestedPlaces={},b.suggestedPlaces[l.publishedPlace.id]=l.publishedPlace),b.annotation=void 0,b.boxes=[],b.images=[],b.isThereASelection=!1,b.configuration=l,b.messages=[],r.load(Object.keys(b.configuration.entities)),s.$on("analysisFailed",function(t,e){return b.analysisFailed=!0,b.addMsg(e,"error")}),s.$on("analysisServiceStatusUpdated",function(t,e){return b.isRunning=e,i.updateContentEditableStatus(!e)}),s.$watch("selectionStatus",function(){return b.isThereASelection=s.selectionStatus}),e=0,n=(a=b.configuration.classificationBoxes).length;e<n;e++)x=a[e],b.selectedEntities[x.id]={};return b.removeMsg=function(t){return b.messages.splice(t,1)},b.addMsg=function(t,e){return b.messages.unshift({level:e,text:t})},b.selectAnnotation=function(t){return i.selectAnnotation(t)},b.hasAnalysis=function(){return null!=b.analysis},b.isEntitySelected=function(t,e){return null!=b.selectedEntities[e.id][t.id]},b.isLinkedToCurrentAnnotation=function(t){var e;return e=b.annotation,0<=P.call(t.occurrences,e)},b.addNewEntityToAnalysis=function(){var t;return delete b.currentEntity.suggestedSameAs,b.analysis.entities[b.currentEntity.id]=b.currentEntity,(t=b.analysis.annotations[b.annotation]).entityMatches.push({entityId:b.currentEntity.id,confidence:1}),b.analysis.entities[b.currentEntity.id].annotations[t.id]=t,b.analysis.annotations[b.annotation].entities[b.currentEntity.id]=b.currentEntity,b.onSelectedEntityTile(b.analysis.entities[b.currentEntity.id])},b.$on("updateOccurencesForEntity",function(t,e,n){var i,r;if(m.debug("Updating "+n.length+" occurrence(s) for "+e+"..."),b.analysis.entities[e].occurrences=n,wp.wordlift.trigger("updateOccurrencesForEntity",{entityId:e,occurrences:n}),0===n.length){for(x in r=[],i=b.selectedEntities)i[x],r.push(delete b.selectedEntities[x][e]);return r}}),b.$watch("annotation",function(t){var e;if(m.debug("Current annotation id changed to "+t),wp.wordlift.trigger("annotation",t),!b.isRunning&&null!=t)return null!=b.currentEntity?(e=b.analysis.annotations[t],b.currentEntity.label=e.text,o.getSuggestedSameAs(e.text)):void 0}),b.$on("textAnnotationClicked",function(t,e){return b.annotation=e,b.unsetCurrentEntity()}),b.$on("textAnnotationAdded",function(t,e){return m.debug("added a new annotation with Id "+e.id),b.analysis.annotations[e.id]=e,b.annotation=e.id}),b.$on("sameAsRetrieved",function(t,e){return b.currentEntity.suggestedSameAs=e}),b.$on("relatedPostsLoaded",function(t,e){return b.relatedPosts=e}),b.$on("analysisPerformed",function(t,e){var n,i,r,o,s,a,l,d,u,c,f,g,p,h,y,v,w;if(m.info("An analysis has been performed."),b.analysis=e,null!=b.configuration.topic)for(m.info("Preselecting topics..."),s=0,l=(p=e.topics).length;s<l;s++)h=(w=p[s]).id,0<=P.call(b.configuration.topic.sameAs,h)&&(b.topic=w);for(a=0,d=(y=b.configuration.classificationBoxes).length;a<d;a++)for(f=0,u=(n=(x=y[a]).selectedEntities).length;f<u;f++)if(r=n[f],i=e.entities[r]){if(0===i.occurrences.length){m.warn("Entity "+r+" selected as "+x.label+" without valid occurrences!",i);continue}for(b.selectedEntities[x.id][r]=e.entities[r],g=0,c=(v=i.images).length;g<c;g++)o=v[g],P.call(b.images,o)<0&&b.images.push(o)}else m.warn("Entity with id "+r+" should be linked to "+x.id+" but is missing");return b.currentSection="content-classification"}),b.updateRelatedPosts=function(){var t,e,n,i;for(x in m.debug("Going to update related posts box ..."),e=[],i=b.selectedEntities)for(n in t=i[x])t[n],e.push(n);return r.load(e)},b.onSelectedEntityTile=function(e){var t,n,i,r,o,s,a;if(t="entitySelected",null!=b.annotation?(o=b.annotation,0<=P.call(e.occurrences,o)&&(t="entityDeselected")):0<e.occurrences.length&&(t="entityDeselected"),a=l.getCategoryForType(e.mainType),m.debug("Action '"+t+"' on entity "+e.id+" within "+a+" scope"),"entitySelected"===t)for(i=0,r=(s=(b.selectedEntities[a][e.id]=e).images).length;i<r;i++)n=s[i],P.call(b.images,n)<0&&b.images.push(n);else b.images=b.images.filter(function(t){return P.call(e.images,t)<0});return b.$emit(t,e,b.annotation),wp.wordlift.trigger(t,{entity:e,annotation:b.annotation}),b.updateRelatedPosts(),b.selectAnnotation(void 0)},b.isGeoLocationAllowed=function(){return t.isAllowed()},b.getLocation=function(){return b.isGeolocationRunning=!0,s.$broadcast("geoLocationStatusUpdated",b.isGeolocationRunning),t.getLocation()},b.isPublishedPlace=function(t){var e;return t.id===(null!=(e=b.publishedPlace)?e.id:void 0)},b.hasPublishedPlace=function(){return null!=b.publishedPlace||null!=b.suggestedPlaces},b.onPublishedPlaceSelected=function(t){var e;return(null!=(e=b.publishedPlace)?e.id:void 0)===t.id?(b.publishedPlace=void 0,void(b.suggestedPlaces=void 0)):b.publishedPlace=t},b.$on("currentUserLocalityDetected",function(t,e,r){return m.debug("Looking for entities matching "+e+" for locality "+r),o._innerPerform(e).then(function(t){var e,n,i;for(n in b.suggestedPlaces={},i=t.data.entities)"place"===(e=i[n]).mainType&&r===e.label&&(e.id=n,b.onPublishedPlaceSelected(e));return b.isGeolocationRunning=!1,s.$broadcast("geoLocationStatusUpdated",b.isGeolocationRunning)})}),b.$on("geoLocationError",function(t,e){return b.addMsg("Sorry. Looks like something went wrong and WordLift cannot detect your current position. Make sure the â€‹location servicesâ€‹ of your browser are turned on.","error"),b.isGeolocationRunning=!1,s.$broadcast("geoLocationStatusUpdated",b.isGeolocationRunning)}),b.isTopic=function(t){var e;return t.id===(null!=(e=b.topic)?e.id:void 0)},b.onTopicSelected=function(t){var e;if((null!=(e=b.topic)?e.id:void 0)!==t.id)return b.topic=t;b.topic=void 0}}]),angular.module("wordlift.editpost.widget.directives.wlClassificationBox",[]).directive("wlClassificationBox",["configuration","$log",function(t,e){return{restrict:"E",scope:!0,transclude:!0,templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-classification-box.html"},link:function(t,e,n,i){return t.hasSelectedEntities=function(){return 0<Object.keys(t.selectedEntities[t.box.id]).length},wp.wordlift.trigger("wlClassificationBox.loaded",t)},controller:function(o,t,e){return o.tiles=[],o.boxes[o.box.id]=o,this.addTile=function(t){return o.tiles.push(t)},this.closeTiles=function(){var t,e,n,i,r;for(i=[],t=0,e=(n=o.tiles).length;t<e;t++)r=n[t],i.push(r.isOpened=!1);return i}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityList",[]).directive("wlEntityList",["$log",function(t){return{restrict:"A",link:function(){return wp.wordlift.trigger("wlEntityList.loaded")}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityForm",[]).directive("wlEntityForm",["configuration","$window","$log",function(i,r,o){return{restrict:"E",scope:{entity:"=",onSubmit:"&",onReset:"&",box:"="},templateUrl:function(){return i.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-form.html?ver=3.19.5"},link:function(s,t,e,n){return s.configuration=i,s.currentCategory=void 0,s.$watch("entity.id",function(t){var e,n;if(null!=t)return o.debug("Entity updated to "+t),e=i.getCategoryForType(null!=(n=s.entity)?n.mainType:void 0),o.debug("Going to update current category to "+e),s.currentCategory=e}),s.onSubmitWrapper=function(t){return t.preventDefault(),s.onSubmit()},s.onResetWrapper=function(t){return t.preventDefault(),s.onReset()},s.setCurrentCategory=function(t){var e;if(s.currentCategory=t,e=i.getTypesForCategoryId(t),o.debug("Going to check types"),o.debug(e),1===e.length)return s.setType(e[0])},s.unsetCurrentCategory=function(){var t;return s.currentCategory=void 0,null!=(t=s.entity)?t.mainType=void 0:void 0},s.isSameAsOf=function(t){var e;return e=t.id,0<=P.call(s.entity.sameAs,e)},s.addSameAs=function(t){var e,n,i,r,o;return(null!=(n=s.entity)?n.sameAs:void 0)||null!=(i=s.entity)&&(i.sameAs=[]),r=t.id,0<=P.call(s.entity.sameAs,r)?(e=s.entity.sameAs.indexOf(t.id),s.entity.sameAs.splice(e,1)):null!=(o=s.entity)?o.sameAs.push(t.id):void 0},s.setType=function(t){var e,n;if(t!==(null!=(e=s.entity)?e.mainType:void 0))return null!=(n=s.entity)?n.mainType=t:void 0},s.isCurrentType=function(t){var e;return(null!=(e=s.entity)?e.mainType:void 0)===t},s.getAvailableTypes=function(){return i.getTypesForCategoryId(s.currentCategory)},s.removeCurrentImage=function(t){var e;return e=s.entity.images.splice(t,1),o.warn("Removed "+e+" from entity "+s.entity.id+" images collection")},s.linkToEdit=function(t){return t.preventDefault(),r.location.href=ajaxurl+"?action=wordlift_redirect&uri="+r.encodeURIComponent(s.entity.id)+"&to=edit"},s.hasOccurences=function(){var t;return 0<(null!=(t=s.entity.occurrences)?t.length:void 0)},s.setSameAs=function(t){return s.entity.sameAs=t},s.isInternal=function(){var t;return i.isInternal(null!=(t=s.entity)?t.id:void 0)},s.isNew=function(t){var e;return!/^(f|ht)tps?:\/\//i.test(null!=(e=s.entity)?e.id:void 0)}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityTile",[]).directive("wlEntityTile",["configuration","$log",function(r,t){return{require:"?^wlClassificationBox",restrict:"E",scope:{entity:"=",isSelected:"=",showConfidence:"=",onSelect:"&",onMore:"&"},templateUrl:function(){return r.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-tile.html"},link:function(t,e,n,i){return t.configuration=r,null!=i&&i.addTile(t),t.isOpened=!1,t.isInternal=function(){return!!t.entity.id.startsWith(r.datasetUri)},t.toggle=function(){return t.isOpened||null!=i&&i.closeTiles(),t.isOpened=!t.isOpened}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityInputBox",[]).directive("wlEntityInputBox",["configuration","$log",function(t,e){return{restrict:"E",scope:{entity:"="},templateUrl:function(){return t.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-input-box.html?ver=3.19.5"}}}]),angular.module("wordlift.editpost.widget.services.EditorAdapter",["wordlift.editpost.widget.services.EditorAdapter"]).service("EditorAdapter",["$log",function(t){var n;return n={getEditor:function(t){var e,n,i;return null==t&&(t=null!=(e=window.wlSettings.default_editor_id)?e:"content"),tinyMCE.get(null!=(n="undefined"!=typeof wp&&null!==wp&&null!=(i=wp.hooks)?i.applyFilters("wl_default_editor_id",t):void 0)?n:t)},getHTML:function(t){var e;return null==t&&(t=null!=(e=window.wlSettings.default_editor_id)?e:"content"),n.getEditor(t).getContent({format:"raw"})}}}]),angular.module("wordlift.editpost.widget.services.AnnotationParser",[]).service("AnnotationParser",["$log",function(t){return{parse:function(t){var e,n,i,r,o;for(o=A.create(t),i=/<(\w+)[^>]*\sitemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,r=[];n=i.exec(t);)e={start:o.html2text(n.index),end:o.html2text(n.index+n[0].length),uri:n[2],label:n[3]},r.push(e);return r}}}]),angular.module("wordlift.editpost.widget.services.AnalysisService",["wordlift.editpost.widget.services.AnnotationParser","wordlift.editpost.widget.services.EditorAdapter"]).service("AnalysisService",["AnnotationParser","EditorAdapter","configuration","$log","$http","$rootScope",function(i,r,$,C,o,s){var n,f,t,e,a,l,d,u,c,g,p,h;for(h=function(t){var e;for(null==t&&(t=8),e="";e.length<t;)e+=Math.random().toString(36).substr(2);return e.substr(0,t)},d=function(t,e){return n(n({},t),e)},n=function(t,e){var n,i;for(n in e)i=e[n],t[n]=i;return t},g={_isRunning:!(f=function(t,e,n){var i,r;for(r in t)if((i=t[r]).start===e&&i.end===n)return i}),_currentAnalysis:void 0,_supportedTypes:[],_defaultType:"thing",cleanAnnotations:function(t,e){var n,i,r,o,s,a,l,d,u,c;for(i in null==e&&(e=[]),d=t.annotations)if(0<(n=d[i]).start&&n.end>n.start){for(o=!1,s=0,a=(r=function(){c=[];for(var t=u=n.start,e=n.end;u<=e?t<=e:e<=t;u<=e?t++:t--)c.push(t);return c}.apply(this)).length;s<a;s++){l=r[s],0<=P.call(e,l)&&(o=!0);break}o?(C.warn("Annotation with id: "+i+" start: "+n.start+" end: "+n.end+" overlaps an existing annotation"),this.deleteAnnotation(t,i)):e=e.concat(r)}return t}},t=0,a=(u=$.classificationBoxes).length;t<a;t++)for(e=0,l=(c=u[t].registeredTypes).length;e<l;e++)p=c[e],P.call(g._supportedTypes,p)<0&&g._supportedTypes.push(p);return g.createEntity=function(t){var e;return null==t&&(t={}),e={id:"local-entity-"+h(32),label:"",description:"",mainType:"",types:[],images:[],confidence:1,occurrences:[],annotations:{}},d(e,t)},g.deleteAnnotation=function(t,e){var n,i,r,o,s;if(C.warn("Going to remove overlapping annotation with id "+e),null!=t.annotations[e]){for(i=r=0,o=(s=t.annotations[e].entityMatches).length;r<o;i=++r)n=s[i],delete t.entities[n.entityId].annotations[e];delete t.annotations[e]}return t},g.createAnnotation=function(t){var e;return null==t&&(t={}),e={id:"urn:local-text-annotation-"+h(32),text:"",start:0,end:0,entities:[],entityMatches:[]},d(e,t)},g.parse=function(r){var o,t,e,s,n,i,a,l,d,u,c,f,g,p,h,y,v,w,m,b,x,E,A,S;for(a in e=this._defaultType,null!=r.topics&&(r.topics=r.topics.map(function(t){return t.id=t.uri,t.occurrences=[],t.mainType=e,t})),C.debug("Found "+Object.keys($.entities).length+" entities in configuration...",$),v=$.entities)f=v[a],r.entities[a]=f;for(a in w=r.entities)i=w[a],$.currentPostUri!==a?(i.label||C.warn("Label missing for entity "+a),i.description||C.warn("Description missing for entity "+a),i.sameAs||(C.warn("sameAs missing for entity "+a),i.sameAs=[],null!=(m=$.entities[a])&&(m.sameAs=[]),C.debug("Schema.org sameAs overridden for entity "+a)),b=i.mainType,P.call(this._supportedTypes,b)<0&&(C.warn("Schema.org type "+i.mainType+" for entity "+a+" is not supported from current classification boxes configuration"),i.mainType=this._defaultType,null!=(x=$.entities[a])&&(x.mainType=this._defaultType),C.debug("Schema.org type overridden for entity "+a)),i.id=a,i.occurrences=[],i.annotations={}):delete r.entities[a];for(a in E=r.annotations)if((o=E[a]).id=a,o.entities={},r.annotations[a].entityMatches=function(){var t,e,n,i;for(i=[],t=0,e=(n=o.entityMatches).length;t<e;t++)(s=n[t]).entityId in r.entities&&i.push(s);return i}(),0!==r.annotations[a].entityMatches.length)for(l=d=0,u=(A=r.annotations[a].entityMatches).length;d<u;l=++d)s=A[l],r.entities[s.entityId].label||(r.entities[s.entityId].label=o.text,C.debug("Missing label retrieved from related annotation for entity "+s.entityId)),r.entities[s.entityId].annotations[a]=o,r.annotations[a].entities[s.entityId]=r.entities[s.entityId];else delete r.annotations[a];for(a in S=r.entities)for(t in i=S[a],h=r.annotations){for(g=1,p=0,c=(y=(o=h[t]).entityMatches).length;p<c;p++)null!=(n=y[p]).entityId&&n.entityId===a&&(g=n.confidence);i.confidence=i.confidence*g}return r},g.getSuggestedSameAs=function(t){var e,n,i,r,o;for(n in this._innerPerform(t).then(function(t){}),o=[],r=response.data.entities)e=r[n],(i=n.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i))&&o.push({id:n,label:e.label,mainType:e.mainType,source:i[1]});return C.debug(o),s.$broadcast("sameAsRetrieved",o)},g._innerPerform=function(t,e){var n;return null==e&&(e=[]),(n={method:"post",url:ajaxurl+"?action=wordlift_analyze",headers:{"Content-Type":"application/json"}}).data={content:t,annotations:e,contentType:"text/html",version:A.version},"undefined"!=typeof wlSettings&&null!==wlSettings&&(null!=wlSettings.language&&(n.data.contentLanguage=wlSettings.language),null!=wlSettings.itemId&&(n.data.exclude=[wlSettings.itemId]),this.canCreateEntities?n.data.scope="all":n.data.scope="local"),o(n)},g._updateStatus=function(t){return g._isRunning=t,s.$broadcast("analysisServiceStatusUpdated",t)},g.perform=function(t){var e,n;return g._currentAnalysis?(C.warn("Analysis already run! Nothing to do ..."),void g._updateStatus(!1)):(g._updateStatus(!0),e=i.parse(r.getHTML()),C.debug("Requesting analysis..."),(n=this._innerPerform(t,e)).then(function(t){var e;if(null==t.data.success||t.data.success)return g._currentAnalysis=t.data,e=g.parse(t.data),s.$broadcast("analysisPerformed",e),wp.wordlift.trigger("analysis.result",e);s.$broadcast("analysisFailed",t.data.data.message)}),n.catch(function(t){return C.error(t.data),s.$broadcast("analysisFailed",t.data)}),n.finally(function(t){return g._updateStatus(!1)}))},g.preselect=function(t,e){var n,i,r,o,s,a,l,d,u,c;for(C.debug("Selecting "+e.length+" entity annotation(s)..."),u=[],s=0,a=e.length;s<a;s++)if((n=e[s]).start!==n.end){for(o in null==(c=f(t.annotations,n.start,n.end))&&(C.warn("Text annotation "+n.start+":"+n.end+" for entityId "+n.uri+" misses in the analysis"),c=this.createAnnotation({start:n.start,end:n.end,text:n.label,cssClass:null!=n.cssClass?n.cssClass:void 0}),t.annotations[c.id]=c),r=t.entities[n.uri],l=$.entities)i=l[o],d=n.uri,0<=P.call(i.sameAs,d)&&(r=t.entities[i.id]);null!=r?(t.entities[r.id].occurrences.push(c.id),null==t.entities[r.id].annotations[c.id]?(t.entities[r.id].annotations[c.id]=c,t.annotations[c.id].entityMatches.push({entityId:r.id,confidence:1}),u.push(t.annotations[c.id].entities[r.id]=t.entities[r.id])):u.push(void 0)):C.warn("Entity with uri "+n.uri+" is missing both in analysis results and in local storage")}else C.warn("There is a broken empty annotation for entityId "+n.uri);return u},g.canCreateEntities=null!=wlSettings.can_create_entities&&"yes"===wlSettings.can_create_entities,g}]),angular.module("wordlift.editpost.widget.services.EditorService",["wordlift.editpost.widget.services.EditorAdapter","wordlift.editpost.widget.services.AnalysisService"]).service("EditorService",["configuration","AnalysisService","EditorAdapter","$log","$http","$rootScope",function(l,v,w,m,t,b){var c,a,f,x,E,n;return"\ufeff",x=function(t){var e,n,i,r,o;for(o=A.create(t),i=/<(\w+)[^>]*\sclass="([^"]+)"\s+(?:id="[^"]+"\s+)?itemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,r=[];n=i.exec(t);)e={start:o.html2text(n.index),end:o.html2text(n.index+n[0].length),uri:n[3],label:n[4],cssClass:n[2]},r.push(e);return r},E=function(t){var n,e,i,r,o,s;for(r=[],e=0,i=t.length;e<i;e++)n=t[e],r=r.concat(function(){s=[];for(var t=o=n.start,e=n.end;o<=e?t<=e:e<=t;o<=e?t++:t--)s.push(t);return s}.apply(this));return r},function(){return tinyMCE.get("content")},f=function(t,e){var n,i,r,o,s,a;for((i=w.getEditor()).dom.addClass(t,"disambiguated"),r=0,o=(s=l.types).length;r<o;r++)a=s[r],i.dom.removeClass(t,a.css);return i.dom.removeClass(t,"unlinked"),i.dom.addClass(t,"wl-"+e.mainType),n=i.dom.getAttrib(t,"itemid"),i.dom.setAttrib(t,"itemid",e.id),n},a=function(t,e){var n,i;return(i=w.getEditor()).dom.removeClass(t,"disambiguated"),i.dom.removeClass(t,"wl-"+e.mainType),n=i.dom.getAttrib(t,"itemid"),i.dom.setAttrib(t,"itemid",""),n},c=function(t){var e,n,i,r,o,s;if(m.info("Calculating occurrences for entity "+t+"..."),i=w.getEditor(),s=[],""===t)return s;for(n=i.dom.select("span.textannotation"),m.info("Found "+n.length+" annotation(s) for entity "+t+"."),r=0,o=n.length;r<o;r++)e=n[r],i.dom.getAttrib(e.id,"itemid")===t&&s.push(e.id);return s},b.$on("analysisPerformed",function(t,e){if(null!=e&&null!=e.annotations)return n.embedAnalysis(e)}),b.$on("entitySelected",function(t,e,n){var i,r,o,s,a,l,d,u;if(r=[],null!=n)r.push(f(n,e));else for(s in u=e.annotations)i=u[s],r.push(f(i.id,e));for(a=0,l=r.length;a<l;a++)(o=r[a])&&(d=c(o),b.$broadcast("updateOccurencesForEntity",o,d));return d=c(e.id),b.$broadcast("updateOccurencesForEntity",e.id,d)}),b.$on("entityDeselected",function(t,e,n){var i,r,o,s;if(null!=n)a(n,e);else for(r in s=e.annotations)i=s[r],a(i.id,e);return o=c(e.id),b.$broadcast("updateOccurencesForEntity",e.id,o)}),n={hasSelection:function(){var t;return null!=(t=w.getEditor())&&!t.selection.isCollapsed()},isEditor:function(t){return w.getEditor().id===t.id},updateContentEditableStatus:function(t){return w.getEditor().getBody().setAttribute("contenteditable",t)},createTextAnnotationFromCurrentSelection:function(){var t,e,n,i,r,o,s,a;if(!(e=w.getEditor()).selection.isCollapsed())return i=""+e.selection.getSel(),o='<span id="'+(r=v.createAnnotation({text:i})).id+'" class="textannotation unlinked selected">'+e.selection.getContent()+"</span>\ufeff",e.selection.setContent(o),t=w.getHTML(),a=A.create(t),n=t.indexOf(o),s=a.html2text(n),r.start=s,r.end=r.start+i.length,b.$broadcast("textAnnotationAdded",r);m.warn("Invalid selection! The text annotation cannot be created")},selectAnnotation:function(t){var e,n,i,r,o;for(i=0,r=(o=(n=w.getEditor()).dom.select("span.textannotation")).length;i<r;i++)e=o[i],n.dom.removeClass(e.id,"selected");if(b.$broadcast("textAnnotationClicked",void 0),n.dom.hasClass(t,"textannotation"))return n.dom.addClass(t,"selected"),b.$broadcast("textAnnotationClicked",t)},embedAnalysis:function(t){var e,n,i,r,o,s,a,l,d,u,c,f,g,p,h,y;for(i=w.getEditor(),l=w.getHTML(),s=x(l),v.cleanAnnotations(t,E(s)),v.preselect(t,s);l.match(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]+)<\/\1>/gim,"$2");)l=l.replace(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]*)<\/\1>/gim,"$2");for(n in y=A.create(l),f=t.annotations)if(0!==(e=f[n]).entityMatches.length){for(r='<span id="'+n+'" class="textannotation',-1<(null!=(g=e.cssClass)?g.indexOf("wl-no-link"):void 0)&&(r+=" wl-no-link"),-1<(null!=(p=e.cssClass)?p.indexOf("wl-link"):void 0)&&(r+=" wl-link"),u=0,c=(h=e.entityMatches).length;u<c;u++)o=h[u],a=t.entities[o.entityId],0<=P.call(a.occurrences,n)&&(r+=" disambiguated wl-"+a.mainType+'" itemid="'+a.id);r+='">',y.insertHtml(r,{text:e.start}),y.insertHtml("</span>",{text:e.end})}else m.warn("Annotation "+e.text+" ["+e.start+":"+e.end+"] with id "+e.id+" has no entity matches!");return l=(l=y.getHtml()).replace(/<\/span>/gim,"</span>\ufeff"),b.$broadcast("analysisEmbedded"),d=i.isDirty(),i.setContent(l,{format:"raw"}),i.isNotDirty=!d}}}]),angular.module("wordlift.editpost.widget.services.RelatedPostDataRetrieverService",[]).service("RelatedPostDataRetrieverService",["configuration","$log","$http","$rootScope",function(n,i,r,o){return{load:function(t){var e;return null==t&&(t=[]),e="admin-ajax.php?action=wordlift_related_posts&post_id="+n.currentPostId,r({method:"post",url:e,data:t}).success(function(t){return o.$broadcast("relatedPostsLoaded",t)}).error(function(t,e){return i.warn("Error loading related posts")})}}}]),angular.module("wordlift.editpost.widget.services.GeoLocationService",["geolocation"]).service("GeoLocationService",["configuration","geolocation","$log","$rootScope","$document","$q","$timeout","$window",function(t,e,n,d,r,o,s,i){var a,u,l,c;return u="locality","AIzaSyAhsajbqNVd7ABlkZvskWIPdiX6M3OaaNM",a="https://maps.googleapis.com/maps/api/js?language="+t.currentLanguage+"&key=AIzaSyAhsajbqNVd7ABlkZvskWIPdiX6M3OaaNM",d.$on("error",function(t,e){return n.warn("Geolocation error: "+e),d.$broadcast("geoLocationError",e)}),this.googleApiLoaded=!1,this.googleApiPromise=void 0,c=function(){var t,n,i;return null!=this.googleApiPromise||(n=o.defer(),(i=r[0].createElement("script")).src=a,r[0].body.appendChild(i),t=function(t){var e;if(!i.readyState||"complete"===(e=i.readyState)||"loaded"===e)return s(function(){return n.resolve(t)})},i.onload=t,i.onreadystatechange=t,i.onerror=function(t){return s(function(){return n.reject(t)})},this.googleApiPromise=n.promise),this.googleApiPromise},l=function(){var t,e,n;for(e in n=i.navigator.userAgent,t={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer/i})if(t[e].test(n))return e;return"unknown"},{isAllowed:function(){return"chrome"!==l()||"https:"===i.location.protocol},getLocation:function(){return e.getLocation().then(function(t){return n.debug("Detected position: latitude "+t.coords.latitude+", longitude "+t.coords.longitude),c().then(function(){return(new google.maps.Geocoder).geocode({location:{lat:t.coords.latitude,lng:t.coords.longitude}},function(t,e){var n,i,r,o,s,a,l;if(e===google.maps.GeocoderStatus.OK)for(i=0,o=t.length;i<o;i++)if(l=t[i],0<=P.call(l.types,u))for(r=0,s=(a=l.address_components).length;r<s;r++)if(n=a[r],0<=P.call(n.types,u))return void d.$broadcast("currentUserLocalityDetected",l.formatted_address,n.long_name)})})})}}}]),angular.module("wordlift.editpost.widget.providers.ConfigurationProvider",[]).provider("configuration",function(){var e;return e=void 0,{setConfiguration:function(t){return(e=t).getCategoryForType=function(t){var e,n,i,r;if(t)for(n=0,i=(r=this.classificationBoxes).length;n<i;n++)if(e=r[n],0<=P.call(e.registeredTypes,t))return e.id},e.getTypesForCategoryId=function(t){var e,n,i,r;if(!t)return[];for(n=0,i=(r=this.classificationBoxes).length;n<i;n++)if(t===(e=r[n]).id)return e.registeredTypes},e.isInternal=function(t){return null!=t?t.startsWith(this.datasetUri):void 0},e.getUriForType=function(t){var e,n,i,r;for(e=0,n=(i=this.types).length;e<n;e++)if((r=i[e]).css==="wl-"+t)return r.uri}},$get:function(){return e}}}),c=jQuery,angular.module("wordlift.editpost.widget",["ngAnimate","wordlift.ui.carousel","wordlift.utils.directives","wordlift.editpost.widget.providers.ConfigurationProvider","wordlift.editpost.widget.controllers.EditPostWidgetController","wordlift.editpost.widget.directives.wlClassificationBox","wordlift.editpost.widget.directives.wlEntityList","wordlift.editpost.widget.directives.wlEntityForm","wordlift.editpost.widget.directives.wlEntityTile","wordlift.editpost.widget.directives.wlEntityInputBox","wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.RelatedPostDataRetrieverService"]).config(function(t){return t.setConfiguration(window.wordlift)}),c(c('<div\n      id="wordlift-edit-post-wrapper"\n      ng-controller="EditPostWidgetController"\n      ng-include="configuration.defaultWordLiftPath + \'templates/wordlift-widget-be/wordlift-editpost-widget.html?ver=3.19.5\'">\n    </div>').appendTo("#wordlift-edit-post-outer-wrapper"),c('<div class="wl-widget-spinner">\n  <svg transform-origin="10 10" id="wl-widget-spinner-blogger">\n    <circle cx="10" cy="10" r="6" class="wl-blogger-shape"></circle>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-editorial">\n    <rect x="4" y="4" width="12" height="12" class="wl-editorial-shape"></rect>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-enterprise">\n    <polygon points="3,10 6.5,4 13.4,4 16.9,10 13.4,16 6.5,16" class="wl-enterprise-shape"></polygon>\n  </svg>\n</div>').appendTo("#wordlift_entities_box .ui-sortable-handle"),f=angular.bootstrap(c("#wordlift-edit-post-wrapper"),["wordlift.editpost.widget"]),f.invoke(["$rootScope","$log",function(t,e){return t.$on("analysisServiceStatusUpdated",function(t,e){var n;return n=e?"wl-spinner-running":"",c(".wl-widget-spinner svg").attr("class",n)}),t.$on("geoLocationStatusUpdated",function(t,e){var n;return n=e?"wl-spinner-running":"",c(".wl-widget-spinner svg").attr("class",n)}),wp.wordlift.on("loading",function(t){var e;return e=t?"wl-spinner-running":"",c(".wl-widget-spinner svg").attr("class",e)})}]),tinymce.PluginManager.add("wordlift",function(r,t){var n,e,i,o,s,a,l,d,u;if(i=null!=(a=null!=(null!=(l=window.wlSettings)?l.default_editor_id:void 0))?a:"content",o="undefined"!=typeof wp&&null!==wp&&null!=(d=wp.hooks)?d.applyFilters("wl_default_editor_id",i):void 0,r.id===o)return s=function(t,e,n){switch(tinymce.majorVersion){case"4":return t.on(e,n);case"3":return t["on"+e].add(n)}},(e=c("#wordlift_entities_box").hasClass("closed"))||f.invoke(["EditorService","$rootScope","$log",function(t,e,n){var i,r,o,s,a,l;for(null!=wp.autosave&&(wp.autosave.server.postChanged=function(){return!1}),l=[],i=0,r=(a=["setMarkers","toViews"]).length;i<r;i++){if(o=a[i],null!=wp.mce.views[o]){s=wp.mce.views[o],n.warn("Override wp.mce.views method "+o+"() to prevent shortcodes rendering"),wp.mce.views[o]=function(t){return t},e.$on("analysisEmbedded",function(t){return n.info("Going to restore wp.mce.views method "+o+"()"),wp.mce.views[o]=s}),e.$on("analysisFailed",function(t){return n.info("Going to restore wp.mce.views method "+o+"()"),wp.mce.views[o]=s});break}l.push(void 0)}return l}]),u=function(){return f.invoke(["AnalysisService","EditorService","$rootScope","$log",function(e,n,t,i){return t.$apply(function(){var t;if(""!==(t=r.getContent({format:"raw"})))return n.updateContentEditableStatus(!1),e.perform(t)})}])},n=function(){var t;return t=c(r.getBody()),(e=c("#wordlift_entities_box").hasClass("closed"))?t.addClass("wl-postbox-closed"):t.removeClass("wl-postbox-closed")},c(document).on("postbox-toggled",function(t,e){if("wordlift_entities_box"===e.id)return n()}),r.on("init",function(){var t;return n(),t=function(){var t;return t=r.selection.getContent({format:"text"}),wp.wordlift.trigger("editorSelectionChanged",t)},r.on("selectionchange",function(){return t()})}),e?c(document).on("postbox-toggled",function(t,e){if("wordlift_entities_box"===e.id)return u()}):s(r,"LoadContent",u),s(r,"NodeChange",function(t){return f.invoke(["AnalysisService","EditorService","$rootScope","$log",function(t,e,n,i){return t._currentAnalysis&&n.$apply(function(){return n.selectionStatus=e.hasSelection()}),!0}])}),s(r,"Click",function(r){return f.invoke(["AnalysisService","EditorService","$rootScope","$log",function(t,e,n,i){return t._currentAnalysis&&n.$apply(function(){return e.selectAnnotation(r.target.id)}),!0}])})}))}).call(this);